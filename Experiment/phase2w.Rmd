---
title: "Seeking for the two-way phase-transition"
author: 
  - name: "František Kalvas"
    url: https://github.com/frantisek901/Spirals/Experiment
    affiliation: Department of Sociology, University of West Bohemia in Pilsen
    affiliation_url: https://les.zcu.cz
date: '2022-03-25'
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
## Encoding: UTF-8

rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Main focus of this side project is to find phase-transition which happen when we are changing boundary/`Acceptability of different opinion` and `Narrowness of identity group`. Result should be a simple graph showing how ESBG polarization changes with change of `Acceptability of different opinion` and `Narrowness of identity group`.  

Note: Experiment is still running, we are at 26 complete sets of all values combinations out of 120. Also note, that it seems that we are not done yet, we probably will need more sets than 120 and more values of `Narrowness of identity group`.
  

```{r echo=FALSE, include=FALSE}
library(stargazer)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lmtest)
library(forcats)
library(sjmisc)
library(jtools)
library(huxtable)
library(knitr)


# My own functon for renaming in Tidyverse
prejmenuj = function(data, positions, new.names) {
  names(data)[positions] = new.names
  data
}
```



## Loading data

Data are at <http://github.com/frantisek901/Spirals/Experiment>. Experiment is still running and I, FranČesko, from time to time actualize the `*.csv` files at GitHub, then I run script `experiment.R` which loads the data. Now, 2022-03-25, we are at 20 %, roughly. Who is not interested in working with megabytes of `*.csv files`, might use compiled `phase2w.RData`.  

<!-- For avoiding statistical artifact we sampling data -- for each combination of important variables same number of observations/simulations. Here we must note, that per 1 simulation not using identity we have 3 simulations using identity, since it makes no sense to vary `Narrownes of identity group` in case we are not using identity in the model.   -->

Now we load and aggregate these data and factorize and rename selected variables:  

```{r loading, message=FALSE}
## Loading stored data
load("phase2w.RData")

## Preparing individual data 'dfi'
dfi = phase2w %>% 
  ## Filtering variables:
  filter(RS <= 12 | (RS >= 61 & RS <= 74), identity) %>%  
  
  ## Changing some variables to factors:
  mutate(id_threshold = factor(id_threshold),
         boundary = factor(boundary),
         opinions = factor(opinions))


## Summarising 'dfi' into 'dfs':
dfs = dfi %>% 
  group_by(opinions, boundary, identity, id_threshold) %>% 
  summarise(ESBG = mean(ESBG)) %>% ungroup() %>% 

  ## Renaming variables according 2022-03-18 meeting:
  prejmenuj(1:4, c("Opinion dimensions:", "Acceptability of different opinion:", "Identity:", 
                    "Narrowness of identity group:"))

```



## Graph  

Now, let's show our results graphically!  

### Color maps  

```{r color map, fig.width=8, fig.height=25, warning=FALSE}
dfs %>% 
  ggplot() +
  aes(x = `Acceptability of different opinion:`, fill = ESBG, label = round(ESBG, 2),
      y = `Narrowness of identity group:`) +
  facet_wrap(vars(`Opinion dimensions:`), ncol=1) +
  geom_point(alpha = 1, size = 13, shape = 22, col = "white") +
  geom_text(color = "white", size = 3) +
  scale_fill_gradient2(low = "green", mid = "red", high = "black", midpoint = 0.3) +
  labs(title = "Change of polarization in simulations by 'Opinion dimensions' (1, 2, 4),\n'Narrowness of identity group' (0.35--0.6, NA) and\n'Average acceptability of different opinions' (0.05--0.3)",
       x = "Average acceptability of different opinions", 
       caption = "Note: Value 'NA' in 'Narrowness of identity group' indicates that identity constraint is not used.") +
  guides(alpha = "none") +
  theme_minimal() +
  theme(legend.position = "top")  

```

1) the more dimensions the less polarization,
2) the least polarized region is quarter of circle in the right bottom corner, then the left-hand side stripe, and the most polarized is the resting region (the most polarized part of this region seems to move with change of dimensions, but may be it is the artifact of low number of simulations -- sometimes it is upper-right corner, sometimes upper border, sometimes right border)




### Pulped clouds  

For the first graph on pulped clouds we aggregate `Acceptability of different opinion` into 13 categories (we just round 121 original values to 2 digits). Two different levels of polarization are seeable here, but it doesn't look like clouds...   

```{r graph1, fig.width=8, fig.height=14, warning=FALSE}
## For presenting variability we try now boxplots on individual data (non-aggregated):
dfi %>%
  filter(id_threshold %in% seq(0.36, 0.6, 0.03)) %>% 
  # sample_n(2000) %>%
  ## Selecting variables:
  select(opinions, boundary, id_threshold, ESBG) %>% 
  mutate(boundary = as.numeric(as.character(boundary))) %>% 
  
  ## Renaming variables according 2022-03-18 meeting:
  prejmenuj(1:3, c("Opinion dimensions:", "Acceptability of different opinion:",  
                    "Narrowness of identity group:")) %>% 

  ## Graph itself:
  ggplot() +
  aes(x = `Acceptability of different opinion:`, y = ESBG, 
      fill = `Narrowness of identity group:`,
      col = `Narrowness of identity group:`, 
      group = `Acceptability of different opinion:`) +
  facet_wrap(vars(`Narrowness of identity group:`, `Opinion dimensions:`), ncol=3) +
  geom_boxplot(alpha = 0.2) +
  geom_jitter(alpha = 0.2) +
  scale_x_continuous(breaks = seq(0.05, 0.30, 0.05)) +
  labs(title = "Change of polarization in simulations by 'Opinion dimensions' (1, 2, 4),\n'Narrowness of identity group' (0.36--0.6) and 'Average acceptability of different opinions' (0.05--0.3)",
       x = "Average acceptability of different opinions", y = "Polarization") +
  theme_minimal() +
  theme(legend.position = "top")  

```


Now same graph, but with every value:

```{r graph2, fig.width=8, fig.height=32, warning=FALSE}
## For presenting variability we try now boxplots on individual data (non-aggregated):
dfi %>%
  filter(id_threshold %in% seq(0.35, 0.6, 0.01)) %>% 
  # sample_n(2000) %>%
  ## Selecting variables:
  select(opinions, boundary, id_threshold, ESBG) %>% 
  mutate(boundary = as.numeric(as.character(boundary))) %>% 
  
  ## Renaming variables according 2022-03-18 meeting:
  prejmenuj(1:3, c("Opinion dimensions:", "Acceptability of different opinion:",  
                    "Narrowness of identity group:")) %>% 

  ## Graph itself:
  ggplot() +
  aes(x = `Acceptability of different opinion:`, y = ESBG, 
      fill = `Narrowness of identity group:`,
      col = `Narrowness of identity group:`, 
      group = `Acceptability of different opinion:`) +
  facet_wrap(vars(`Narrowness of identity group:`, `Opinion dimensions:`), ncol=3) +
  geom_boxplot(alpha = 0.2) +
  geom_jitter(alpha = 0.2) +
  scale_x_continuous(breaks = seq(0.05, 0.30, 0.05)) +
  labs(title = "Change of polarization in simulations by 'Opinion dimensions' (1, 2, 4),\n'Narrowness of identity group' (0.35--0.6) and 'Average acceptability of different opinions' (0.05--0.3)",
       x = "Average acceptability of different opinions", y = "Polarization") +
  theme_minimal() +
  theme(legend.position = "top")  

```

Now, same data but slightly different graph

```{r graph3, fig.width=8, fig.height=10, warning=FALSE}
## For presenting variability we try now boxplots on individual data (non-aggregated):
dfi %>%
  filter(id_threshold %in% seq(0.35, 0.6, 0.05)) %>% 
  # sample_n(2000) %>%
  ## Selecting variables:
  select(opinions, boundary, id_threshold, ESBG) %>% 
  mutate(boundary = as.numeric(as.character(boundary))) %>% 

  ## Renaming variables according 2022-03-18 meeting:
  prejmenuj(1:3, c("Opinion dimensions:", "Acceptability of different opinion:",  
                    "Narrowness of identity group:")) %>% 


  ## Graph itself:
  ggplot(aes(x = `Acceptability of different opinion:`, y = ESBG, 
             fill = `Narrowness of identity group:`,
             col = `Narrowness of identity group:`, 
             group = `Acceptability of different opinion:`)) +
  facet_wrap(vars(`Narrowness of identity group:`, `Opinion dimensions:`), ncol=3) +
  geom_point(alpha = 0.15) +
  scale_x_continuous(breaks = seq(0.05, 0.30, 0.05)) +
  labs(title = "Change of polarization in simulations by 'Opinion dimensions' (1, 2, 4),\n'Narrowness of identity group' (0.35--0.6) and 'Average acceptability of different opinions' (0.05--0.3)",
       x = "Average acceptability of different opinions", y = "Polarization") +
  theme_minimal() +
  theme(legend.position = "top")
```


```{r graph4, fig.width=8, fig.height=30, warning=FALSE}
## For presenting variability we try now boxplots on individual data (non-aggregated):
dfi %>%
  filter(id_threshold %in% seq(0.35, 0.6, 0.01)) %>% 
  # sample_n(2000) %>%
  ## Selecting variables:
  select(opinions, boundary, id_threshold, ESBG) %>% 
  mutate(boundary = as.numeric(as.character(boundary))) %>% 
  
  ## Renaming variables according 2022-03-18 meeting:
  prejmenuj(1:3, c("Opinion dimensions:", "Acceptability of different opinion:",  
                    "Narrowness of identity group:")) %>% 


  ## Graph itself:
  ggplot(aes(x = `Acceptability of different opinion:`, y = ESBG, 
             fill = `Narrowness of identity group:`,
             col = `Narrowness of identity group:`, 
             group = `Acceptability of different opinion:`)) +
  facet_wrap(vars(`Narrowness of identity group:`, `Opinion dimensions:`), ncol=3) +
  geom_point(alpha = 0.15) +
  scale_x_continuous(breaks = seq(0.05, 0.30, 0.05)) +
  labs(title = "Change of polarization in simulations by 'Opinion dimensions' (1, 2, 4),\n'Narrowness of identity group' (0.35--0.6) and 'Average acceptability of different opinions' (0.05--0.3)",
       x = "Average acceptability of different opinions", y = "Polarization") +
  theme_minimal() +
  theme(legend.position = "top")
```



## Regression   

```{r regression}

m = lm(ESBG ~ opinions+as.numeric(id_threshold)+as.numeric(boundary), data = filter(dfi, identity))
ms = summary(m)

p1 = lm(ESBG ~ opinions+id_threshold+boundary, data = filter(dfi, identity))
p1s = summary(p1)
p1s

f = lm(ESBG ~ opinions*id_threshold*boundary, data = filter(dfi, identity))
fs = summary(f)

```


I just wanna know how much variability we can explain by the full model. OK, we might explain `r (100 * fs[['r.squared']]) %>% round(1)` %, it means there is `r (100 - 100 * fs[['r.squared']]) %>% round(1)` % of variability, which is unexplainable in principle! Resp. we can't explain it by any variable which we manipulated during simulation experiments. As I mentioned above, we might try explain it via detailed description of initial condition (however randomly generated) or via description of the course of the simulation.  

BTW, the full model is not the best, fully factorised model with main effects only is the best (difference in BIC `r round(BIC(f) - BIC(p1), 1)`), this model is better regarding the BIC than the non-factorized model with main effects (difference in BIC `r round(BIC(p1) - BIC(m), 1)`). Just for order, the model with factorized main effects explained  `r (100 * summary(p1)[['r.squared']]) %>% round(1)` % and the model with non-factorized main effects `r (100 * summary(m)[['r.squared']]) %>% round(1)` % of variability.


